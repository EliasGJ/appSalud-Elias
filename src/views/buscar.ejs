<%- include('partials/head') %>

<div class="container my-4">
    <% if (paciente) { %>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="m-0">Detalles del Paciente</h5>
                <div>
                    <a href="/paciente/editar/<%= paciente.id %>" class="btn btn-sm btn-warning text-white me-1">Editar</a>
                    <a href="/paciente/<%= paciente.id %>/historial" class="btn btn-sm btn-outline-info me-1">Historial</a>
                    <form action="/paciente/<%= paciente.id %>?_method=DELETE" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Id</dt>
                    <dd class="col-sm-9"><%= paciente.id %></dd>

                    <dt class="col-sm-3">Nombre</dt>
                    <dd class="col-sm-9"><%= paciente.nombre %></dd>

                    <dt class="col-sm-3">Apellidos</dt>
                    <dd class="col-sm-9"><%= paciente.apellidos %></dd>

                    <dt class="col-sm-3">Fecha de Nacimiento</dt>
                    <dd class="col-sm-9"><%= new Date(paciente.fechaDeNacimiento).toLocaleDateString('es-ES') %></dd>
                </dl>
            </div>
        </div>
    <% } else { %>
        <div class="alert alert-info">No se encontró el paciente.</div>
    <% } %>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card mb-3 shadow-sm">
                    <div class="card-header">Báscula</div>
                    <div class="card-body">
                        <form action="/paciente/<%= paciente ? paciente.id : '' %>/bascula" method="POST" class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Peso (kg)</label>
                                <input type="number" step="0.1" name="peso" class="form-control form-control-sm" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Altura (m)</label>
                                <input type="number" step="0.01" name="altura" class="form-control form-control-sm" required>
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-sm btn-primary" type="submit">Calcular IMC</button>
                            </div>
                        </form>

                        <% if (typeof basculaData !== 'undefined' && basculaData) { %>
                            <hr>
                            <p class="mb-1"><strong>IMC:</strong> <%= basculaData.imc !== null ? basculaData.imc : '—' %></p>
                            <p class="mb-1"><strong>Clasificación:</strong> <%= basculaData.clasificacion || '—' %></p>
                            <p class="mb-0 text-muted small">Último peso: <%= basculaData.peso || '—' %> kg — Altura: <%= basculaData.altura || '—' %> m</p>
                        <% } else if (paciente && paciente.ultimaBascula) { %>
                            <hr>
                            <p class="mb-1"><strong>IMC:</strong> <%= paciente.ultimaBascula.imc !== null ? paciente.ultimaBascula.imc : '—' %></p>
                            <p class="mb-1"><strong>Clasificación:</strong> <%= paciente.ultimaBascula.clasificacion || '—' %></p>
                            <p class="mb-0 text-muted small">Último peso: <%= paciente.ultimaBascula.peso || '—' %> kg — Altura: <%= paciente.ultimaBascula.altura || '—' %> m</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3 shadow-sm">
                    <div class="card-header">Termómetro</div>
                    <div class="card-body">
                        <form action="/paciente/<%= paciente ? paciente.id : '' %>/termometro" method="POST" class="row g-2">
                            <div class="col-8">
                                <label class="form-label small">Temperatura (°C)</label>
                                <input type="number" step="0.1" name="temperatura" class="form-control form-control-sm" required>
                            </div>
                            <div class="col-4 d-flex align-items-end">
                                <button class="btn btn-sm btn-primary w-100" type="submit">Registrar</button>
                            </div>
                        </form>

                        <% if (typeof termometroData !== 'undefined' && termometroData) { %>
                            <hr>
                            <p class="mb-1"><strong>Última (°C):</strong> <%= termometroData.tempC !== null ? termometroData.tempC : '—' %></p>
                            <p class="mb-1"><strong>Última (°F):</strong> <%= termometroData.tempF !== null ? termometroData.tempF : '—' %></p>
                            <p class="mb-1"><strong>Máx / Mín:</strong> <%= termometroData.tempMax || '—' %> °C / <%= termometroData.tempMin || '—' %> °C</p>
                            <p class="mb-0 text-muted small">Anotaciones: <%= termometroData.anotaciones %></p>
                        <% } else if (paciente && paciente.ultimaTemperatura) { %>
                            <hr>
                            <p class="mb-1"><strong>Última (°C):</strong> <%= paciente.ultimaTemperatura.temperaturaC !== null ? paciente.ultimaTemperatura.temperaturaC : '—' %></p>
                            <p class="mb-1"><strong>Última (°F):</strong> <%= paciente.ultimaTemperatura.temperaturaC !== null ? ( (paciente.ultimaTemperatura.temperaturaC * 9/5) + 32).toFixed(2) : '—' %></p>
                            <p class="mb-0 text-muted small">Fecha: <%= paciente.ultimaTemperatura.fecha ? new Date(paciente.ultimaTemperatura.fecha).toLocaleString() : '—' %></p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
                <a href="/" class="btn btn-secondary">Volver a la lista de pacientes</a>
        </div>
</div>

<%- include('partials/footer') %>